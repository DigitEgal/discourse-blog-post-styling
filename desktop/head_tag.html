
<script type="text/discourse-plugin"version="0.8.18">

  const h = require("virtual-dom").h;
  const { ajax } = require("discourse/lib/ajax");
  const blogPostCache = {};

  function isBlogCategory(currentCategory) {
    let allowedCategories = settings.blog_category.split(",");
    let result = false;
    $.each(allowedCategories, (_,c) => { 
      if(currentCategory == c.trim()) {
        result = true;
      }
    });
    return result;
  }

  api.registerConnectorClass('topic-above-post-stream', 'add-blog-image', {
    setupComponent(args, component) {
      let currentCategory = args.model.category;
      if(currentCategory) {
        component.set('blogCategory', isBlogCategory(currentCategory.slug));
      }
    }  
  });

  api.createWidget("blog-image-container", {
    tagName: "div.blog-image-container",
    html(attrs) {
      let cooked = this.getBlogPost(attrs.topic.id);
      if (cooked) {
        let imgLinkStart = cooked.indexOf('"lightbox" href="');
        if(imgLinkStart >= 0) {
          imgLinkStart += 17; // compensate for indexOf string
          let imgLinkEnd = cooked.indexOf('"', imgLinkStart);
          let imgLink = cooked.substring(imgLinkStart, imgLinkEnd);
          return h("div.blog-image", {style: {"background-image": "url(" + imgLink + ")"}});
        }
      }
    },
    getBlogPost(id) {
      if (!blogPostCache[id]) {
        ajax(`/t/${id}.json`).then(response => {
          blogPostCache[id] = response.post_stream.posts[0].cooked;
          this.scheduleRerender();
        });
      }
      return blogPostCache[id];
    }
  });

  api.decorateWidget('blog-image-container:after', helper => {
      helper.widget.appEvents.on('page:changed', () => {
          helper.widget.scheduleRerender();
      });
  });

  // Hide timeline if viewing first post
  api.decorateWidget('topic-timeline:before', helper => {
    let topic = helper.attrs.topic;
    if(isBlogCategory(topic.category.slug) && topic.currentPost == 1) {
      $(".topic-timeline").hide();
    }
    else {
      $(".topic-timeline").show();
    }
  });

  api.modifyClass("component:topic-navigation", {
    _performCheckSize: function() {
      if (!this.element || this.isDestroying || this.isDestroyed) {
        return;
      }

      let info = this.get("info");

      if (info.get("topicProgressExpanded")) {
        info.setProperties({
          renderTimeline: true,
          renderAdminMenuButton: true
        });
      } else {
        let renderTimeline = !this.site.mobileView;

        if (renderTimeline) {
          const width = $(window).width();
          let height = $(window).height();

          if (this.get("composerOpen")) {
            height -= $("#reply-control").height();
          }

          // Additions/Changes
          let topic = this.attrs.topic;
          let category = topic.value.category;

          if(isBlogCategory(category.slug)) {
            renderTimeline = width > 1124 && height > 520;
          } else {
            renderTimeline = width > 924 && height > 520;
          }
          // End Additions/Changes
        }

        info.setProperties({
          renderTimeline,
          renderAdminMenuButton: !renderTimeline
        });
      }
    }
  });

</script>

<script type="text/x-handlebars" data-template-name="/connectors/topic-above-post-stream/add-blog-image">
  {{#if blogCategory}}
   {{mount-widget widget="blog-image-container" args=(hash topic=model)}}
  {{/if}}
</script>
